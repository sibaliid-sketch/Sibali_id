# Nginx perf optimizations
# Caching, compression, HTTP/2
# Enable brotli/gzip for static assets, set long Cache-Control for fingerprinted assets, expires headers, HTTP2 enabled, upstream keepalive, caching proxy for CDN fallback

# Enable HTTP/2
listen 443 ssl http2;

# Brotli compression
brotli on;
brotli_comp_level 6;
brotli_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript application/x-font-ttf application/vnd.ms-fontobject image/svg+xml;

# Gzip compression
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_proxied expired no-cache no-store private must-revalidate auth;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;

# Static asset caching
location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    brotli_static on;
    gzip_static on;
}

# Fingerprinted assets (long cache)
location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)\?v=\w+ {
    expires 1y;
    add_header Cache-Control "public, immutable, max-age=31536000";
    brotli_static on;
    gzip_static on;
}

# Upstream keepalive
upstream app_backend {
    server app:9000;
    keepalive 32;
}

# Proxy caching for CDN fallback
proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=cache_zone:10m max_size=1g inactive=60m use_temp_path=off;
proxy_cache cache_zone;
proxy_cache_valid 200 302 10m;
proxy_cache_valid 404 1m;
proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
proxy_cache_bypass $http_upgrade;

# Expires headers
location ~* \.(txt|xml|json)$ {
    expires 1h;
    add_header Cache-Control "public";
}

location ~* \.(pdf|doc|docx|xls|xlsx)$ {
    expires 1d;
    add_header Cache-Control "public";
}
